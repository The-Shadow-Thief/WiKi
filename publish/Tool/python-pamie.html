<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>PAMIE</title>
    <meta name="generator" content="emacs-wiki.el" />
    <meta http-equiv="Content-Type"
          content="text/html; charset=utf-8" />
    <link rel="made" href="mailto:art.of.war.sunzi@gmail.com" />
    <link rel="home" href="../Programming/WelcomePage.html" />
    <link rel="index" href="../WiKiIndex.html.html" />
    <link rel="stylesheet" type="text/css" href="../css/core.css">
  </head>
  <body>

    <!-- If you want a menu, uncomment the following lines and
    put (require 'emacs-wiki-menu) in your Emacs setup somewhere.

    
    -->

    <h1 id="top">PAMIE</h1>

    <!-- Page published by Emacs Wiki begins here -->
<p>
<h2>北京挂号网站的医院挂号信息的获取</h2>
<h3>python code</h3>
在处理html encode=gb2312的时候，python的code文件在最开始的地方设置为
<pre class="example"># -*- coding: gb2312 -*-
在填写控件的时候就直接写中文就可以了：
ie.textBoxSet('truename','孙川')
但是在查找定位控件的时候这个地方就要这样处理了：
if myDataList[m].encode('gb2312').find(u'预约挂号'.encode('gb2312'))&gt;0:
    if isExpert :
        if myDataList[m].encode('gb2312').find(u'普通门诊'.encode('gb2312'))&lt;0:                        
            RIndex.append(item)
可以看到将控件和要查找的都转化成gb2312，这样是对等了，这样来处理。
</pre>

<h3>验证码的处理</h3>
在处理有些网站的时候其验证码很简单，可以用PIL library来处理。也很方便。
首先是从网站上把PIL download下来，然后安装。
在挂号网站中的验证码是点击一次就到服务器请求一个验证码，像<a href="code1.gif"><img src="code1.gif" alt="" /></a>，所有在此时要注意
你navigate网页，然后你再访问验证码的页面，把验证码解析处理了，然后登陆
这种方法有问题，是因为你这两次访问时没有对应上，所以要把两次的session给
联系起来：
<h5>1. 首先从navigate网页的结果中获取这次nevigate的sessionid，</h5>
<h5>2. 然后再用urllib2去fetch一个网页的时候，设置其html header，将sessionid加上去，</h5>
这里也可以伪装一下crawl，伪装成IE或者firfox
<h5>3. 然后把处理的验证码的结果反填到登陆页面上，就可以实现登陆了。</h5>

<h4>处理验证码的步骤</h4>
<h5>1. 首先是fetch url保存成图片文件的格式，</h5>
<h5>2. 然后是去噪音和去边框</h5>
<h5>3. 然后截取有效的像素点，然后采集，</h5>
本例中的像素点很简单，每一个有效的像素点的位置很规律，
<h5>4. 最好是多拿起网站的验证码进行训练，然后就可以识别了</h5>
这里取巧进行处理。
这里借鉴这位大师的方法： <a href="http://tech.reus.me/?p=534">http://tech.reus.me/?p=534</a>
由于刚才说的这个网站的验证码很简单，所以识别率基本上是100%。

</p>

<h3>PAMIE IE的支持问题</h3>
这里说是PAMIE的IE支持问题其实是pywin32的支持情况，在使用PAMIE之前，
要先下载pywin32，这个是python对windows的系统的一个支持的软件。
这里pywin32只支持IE7，所以在使用IE9的时候，只能在打开IE9的情况下，
在按下F12的dev模式下，将Document mode改成IE7，browsermode也改一下，
可能不改也行。

</p>

<h3>其实现的code</h3>

<p>
放在：<a href="https://github.com/Travis-Sun/hospitalApplication">https://github.com/Travis-Sun/hospitalApplication</a>

</p>

<h2>抢购网站的自动化</h2>

<p>
由于某网站不定期的进行用积分换一些用品，比较实惠，其网站的主体思想就是让大家一致关注着他们。

</p>

<p>
但是换购好的商品性价比比较高，所有很多人都想换购。而且一旦开始，通常情况下几分钟就结束了。

</p>

<p>
所以这个是进行自动化的一个主体的思想。

</p>

<h3>网站的结构</h3>

<p>
先用账号和密码登录到网站上，然后到换购的页面，根据自己的积分进行物品的换购。

</p>

<p>
这里有一个bug，就是在某个物品在本次不参加或者目前没有换购活动的时候，该物品是不会出现在换购物品页面的上，
但是该物品的进行换购页面还是在的，也就是说该物品的换购页面是可以通过参数修改显示出来，
只是在提交确定换购的时候，会进行验证这个物品是否有存货。
所以通过这个页面定期的提交来cover到这个商品的换购期。

</p>

<p>
在这里有一个问题就是在按下提交按钮的时候，有一个验证码要输入，所以要获取这个验证码来实现自动化。

</p>

<p>
网站总体的情况就是这样了。

</p>

<h3>PAMIE的流程</h3>

<p>
这个流程和上面挂号的流程是一样的，但是由于这个页面是asp.net实现的，垃圾信息很多啊。哎不愿意承认的承认（俺就是C#开发人员啊）。
所以search相应的控件比较慢，比老牛拉破车还慢。纠结啊。

</p>

<p>
当然在IE起来之后，转化一下其document mode改一下成IE7模式。

</p>

<p>
然后navigate到换购的界面，然后获得其验证码，这里有一个坑，就是在获得验证码的时候，不仅要获得该会话SessionID，
同时还要获得验证码后面有一个ticket值，这个是访问该页面的时候获得的一个时间戳。

</p>

<h3>验证码的识别</h3>

<p>
这个验证码（像这样<a href="code2.gif"><img src="code2.gif" alt="" /></a>)比挂号的那个复杂，当然也不是复杂的。

</p>

<p>
首先，每个数字或者字符不是等宽度。

</p>

<p>
其次，数字或者字符是倾斜的，分割难度比较高；

</p>

<p>
其次，噪音点颜色丰富，有的和字符/数字本身比较接近，而且噪音在字符上面会其反相作用。

</p>

<p>
最后就是数字/字符本身就是多色彩的像素点，从像素点的绝对值来说是不容易给区分出来。

</p>

<p>
基于这几点，这里验证码的出来要比挂号（上面的例子）要复杂一些，不能像上面那样，简单的切割矩阵，
然后去匹配相应的像素点值来获得验证码的值。

</p>

<p>
此外所有的数字/字符是没有放大和缩小的去吧，就是同一个字符在几次出现情况下大小都是相同。

</p>

<h4>处理的方法：</h4>

<h5>1. 还是将验证码变成单色（白到黑），然后设置一个然后是加强和去噪，然后设置阀值去噪</h5>

<h5>2. 然后每一个像素点的检查，去掉那些奇异点的像素点。</h5>

<p>
所谓奇异点就是每个像素点有上下左右四个邻居，如果某个像素点只有一个邻居或者没有邻居，称之为奇异点。
奇异点是噪音点的可能性很大，所有将其剔除。

</p>

<h5>3. 根据同字符同比例，以及不可分割的特点，通过找其字符/数字的连通来表示想要的字符/数字。</h5>

<p>
通过连通的效果，找到其字符所有的连通点作为表示。这样解决了由于数字/字符的倾斜无法分割的问题。

</p>

<p>
简单说一下方法，这里是用set来存放已访问到的字符有效像素点。因为set能够进行有效快速的合并和求交集。
用一个set的list来存放所有的像素点。

</p>

<ol>
<li>我是自左向右，自上而下的遍历每个像素点，如果该像素点是有效的（白色的）,
我会分别check一下的他的左邻居和上邻居，如果上邻居已经是一个set中的一个有效点，
那么目前处理的有效点一个和上邻居是同一个set集合中，同理如果该点的左邻居也是一个有效点，
而且是某个或者某些个set的一个元素，那么改点和左邻居应该同属这些set的元素。
</li>
<li>在该列处理完之后再处理一遍，check每个有效点是否是多个set的元素，如果是，则合并这些set，
因为这些set的元素是连通在一起的。这样就可以得到所有的字符的有效点的set集合。
</li>
<li>然后由于字符上有噪音，所以很难100%的匹配，所以找到最大概率匹配，这点试过了应该没有问题。
</li>
</ol>

<p>
注意，有时候有用噪音点的干扰是的两个或者多个字符连到一起，这时得到的集合个数就会少于4个，
说明识别失败。重写获取然后在进行识别。

</p>

<h4>code的实现</h4>

<p>
code：<a href="https://github.com/Travis-Sun/child">https://github.com/Travis-Sun/child</a>

</p>

<h2>链家网站数据获取</h2>

<p>
这个是进行不用PAMIE来实现这种等于加验证码识别的功能，也成功。

</p>

<p>
后来估计链家看到了有大量的机器人进行数据的抓取，所以把验证码整的更负责，目前还没有对其进行处理。

</p>

<p>
看了一下，就是干扰比较多比较难分离，其实等宽度的，这个好切割，难辨识。

</p>

<p>
这里主要实现了没有用PAMIE也能实现数据的抓取，结构也可以。

</p>

<p>
code: <a href="https://github.com/Travis-Sun/hourse">https://github.com/Travis-Sun/hourse</a>

</p>

<p>
</p>

</p>

<p>
<a href="python.html">UP</a>
</p>
    <!-- Page published by Emacs Wiki ends here -->
    <div class="navfoot">
      <hr />
      <table width="100%" border="0" summary="Footer navigation">
        <col width="33%" /><col width="34%" /><col width="33%" />
        <tr>
          <td align="left">
            <span class="footdate">Updated: 2012-11-30</span>
          </td>
          <td align="center">
            <span class="foothome">
              <a href="../WiKiIndex.html">Index</a>
            </span>
          </td>
          <td align="right">
            
          </td>
        </tr>
      </table>
    </div>
  </body>
</html>
